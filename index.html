<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse - CardioSense AI</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' }
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        
        @media print {
            body { background: white; color: black; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
    </style>
</head>
<body class="bg-[#020617] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-black text-slate-200 font-sans selection:bg-cyan-500/30 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icon = ({ path, className, size = 24 }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const Icons = {
            Activity: (props) => <Icon path={<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>} {...props} />,
            Upload: (props) => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} {...props} />,
            AlertTriangle: (props) => <Icon path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} {...props} />,
            FileText: (props) => <Icon path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>} {...props} />,
            Zap: (props) => <Icon path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} {...props} />,
            ShieldCheck: (props) => <Icon path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></>} {...props} />,
            Cpu: (props) => <Icon path={<><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/></>} {...props} />,
            Play: (props) => <Icon path={<polygon points="5 3 19 12 5 21 5 3"/>} {...props} />,
            Pause: (props) => <Icon path={<><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></>} {...props} />,
            Database: (props) => <Icon path={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} {...props} />,
            Loader2: (props) => <Icon path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} {...props} />,
            CheckCircle2: (props) => <Icon path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} {...props} />,
            Info: (props) => <Icon path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></>} {...props} />,
            MonitorOff: (props) => <Icon path={<><path d="m17 17 4 4"/><path d="M21 17l-4 4"/><path d="M8 2h8a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Z"/><line x1="12" x2="12" y1="10" y2="14"/><rect x="4" y="14" width="16" height="4" rx="1"/></>} {...props} />,
            Check: (props) => <Icon path={<polyline points="20 6 9 17 4 12"/>} {...props} />,
            RotateCcw: (props) => <Icon path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 5v7h7"/></>} {...props} />,
            Settings: (props) => <Icon path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} {...props} />
        };

        const formatDate = (date) => new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(date);

        // --- COMPONENTS ---
        const StatusBadge = ({ status, confidence }) => {
            let colorClass = "text-emerald-400 bg-emerald-500/10 border-emerald-500/20";
            let IconComp = Icons.ShieldCheck;
            if (status.includes("Tachycardia") || status.includes("Bradycardia") || status.includes("Warning") || status.includes("Irregular") || status.includes("Bigeminy")) { colorClass = "text-amber-400 bg-amber-500/10 border-amber-500/20"; IconComp = Icons.AlertTriangle; }
            else if (status.includes("Critical") || status.includes("Fibrillation") || status.includes("Review") || status.includes("Infarction") || status.includes("V-Tach")) { colorClass = "text-rose-400 bg-rose-500/10 border-rose-500/20 animate-pulse"; IconComp = Icons.Zap; }
            else if (status.includes("Standby") || status.includes("Upload") || status.includes("Signal") || status.includes("Paused")) { colorClass = "text-blue-400 bg-blue-500/10 border-blue-500/20"; IconComp = Icons.Info; }
            else if (status.includes("Complete")) { colorClass = "text-teal-400 bg-teal-500/10 border-teal-500/20"; IconComp = Icons.Check; }
            else if (status.includes("Noise") || status.includes("Error") || status.includes("Artifact")) { colorClass = "text-slate-400 bg-slate-500/10 border-slate-500/20"; IconComp = Icons.MonitorOff; }
            return (<div className={`flex items-center gap-2 px-3 py-1.5 rounded-full border ${colorClass} text-xs font-mono font-bold uppercase tracking-wider shadow-sm backdrop-blur-md transition-all duration-300`}><IconComp size={14} /><span>{status} {confidence > 0 && `(${confidence}%)`}</span></div>);
        };

        const MetricCard = ({ label, value, unit, color = "cyan", subtext }) => {
            const colorMap = {
                cyan: "text-cyan-400 from-cyan-500/20 to-cyan-500/5 border-cyan-500/30", emerald: "text-emerald-400 from-emerald-500/20 to-emerald-500/5 border-emerald-500/30", rose: "text-rose-400 from-rose-500/20 to-rose-500/5 border-rose-500/30", amber: "text-amber-400 from-amber-500/20 to-amber-500/5 border-amber-500/30", blue: "text-blue-400 from-blue-500/20 to-blue-500/5 border-blue-500/30", slate: "text-slate-400 from-slate-500/20 to-slate-500/5 border-slate-500/30", teal: "text-teal-400 from-teal-500/20 to-teal-500/5 border-teal-500/30"
            };
            const bgClass = `bg-gradient-to-br ${colorMap[color].split(' ').slice(1).join(' ')}`;
            const borderClass = colorMap[color].split(' ').pop();
            const textClass = colorMap[color].split(' ')[0];
            return (
                <div className={`relative p-5 rounded-2xl ${bgClass} border ${borderClass} backdrop-blur-md overflow-hidden transition-all duration-300 hover:shadow-lg hover:scale-[1.02]`}>
                    <div className={`absolute -top-6 -right-6 w-24 h-24 bg-${color}-500/10 blur-2xl rounded-full`}></div>
                    <h3 className="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">{label}</h3>
                    <div className="flex items-baseline gap-1.5"><span className={`text-3xl font-mono font-bold ${textClass} drop-shadow-[0_0_10px_rgba(0,0,0,0.5)]`}>{value}</span>{unit && <span className="text-slate-500 text-xs font-mono">{unit}</span>}</div>
                    {subtext && <p className="text-slate-500 text-[10px] mt-2 font-mono opacity-70">{subtext}</p>}
                </div>
            );
        };

        const RiskGauge = ({ risk }) => {
            const getColor = (r) => { if (r === 0) return "bg-slate-700"; if (r < 40) return "bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.5)]"; if (r < 70) return "bg-amber-400 shadow-[0_0_15px_rgba(251,191,36,0.5)]"; return "bg-rose-500 shadow-[0_0_20px_rgba(244,63,94,0.8)] animate-pulse"; };
            return (
                <div className="w-full h-2 bg-slate-800/80 rounded-full overflow-hidden relative backdrop-blur-sm border border-slate-700/50">
                    <div className="absolute inset-0 flex opacity-30"><div className="w-[40%] h-full bg-emerald-500/30 border-r border-slate-900/50"></div><div className="w-[30%] h-full bg-amber-400/30 border-r border-slate-900/50"></div><div className="w-[30%] h-full bg-rose-500/30"></div></div>
                    <div className={`h-full transition-all duration-1000 ease-out rounded-r-full ${getColor(risk)}`} style={{ width: `${risk}%` }} />
                </div>
            );
        };

        const ModelSelector = ({ activeModel, onSelect }) => {
            const models = [
                { id: 'mit-bih', name: 'MIT-BIH', desc: 'Arrhythmia' },
                { id: 'ptb', name: 'PTB-XL', desc: 'Infarction' },
                { id: 'physionet', name: 'PhysioNet', desc: 'AFib/Noise' },
            ];

            return (
                <div className="flex bg-slate-950/50 p-1.5 rounded-xl border border-slate-800/60 backdrop-blur-md">
                    {models.map(m => (
                        <button
                            key={m.id}
                            onClick={() => onSelect(m.id)}
                            className={`flex-1 px-3 py-2.5 rounded-lg text-[10px] font-mono transition-all duration-300 ${
                                activeModel === m.id 
                                ? 'bg-gradient-to-b from-slate-800 to-slate-900 text-cyan-400 shadow-lg border border-slate-700/50' 
                                : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800/30'
                            }`}
                        >
                            <div className="font-bold tracking-wide mb-0.5">{m.name}</div>
                        </button>
                    ))}
                </div>
            );
        };

        const App = () => {
            // STATE
            const [isPlaying, setIsPlaying] = useState(false);
            const [uploadedFileName, setUploadedFileName] = useState(null);
            const [playbackProgress, setPlaybackProgress] = useState(0); 
            const [activeModel, setActiveModel] = useState('mit-bih');
            const [heartRate, setHeartRate] = useState(0);
            const [currentRhythm, setCurrentRhythm] = useState("System Paused");
            const [confidence, setConfidence] = useState(0);
            const [riskScore, setRiskScore] = useState(0);
            const [aiExplanation, setAiExplanation] = useState("System in standby. Please upload ECG data to begin.");
            const [alerts, setAlerts] = useState([]);
            const [isGeneratingReport, setIsGeneratingReport] = useState(false);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [displayData, setDisplayData] = useState([]);

            // REFS FOR LOOP
            const ecgDataRef = useRef([]); // IMPORTANT: Use Ref to avoid stale closures in loop
            const dataIndexRef = useRef(0);
            const requestRef = useRef();
            
            const SAMPLE_RATE = 200; 
            const POINTS_PER_WINDOW = SAMPLE_RATE * 3;
            const SAMPLES_PER_FRAME = 4;

            // --- REAL ANALYSIS ENGINE ---
            const analyzeECGSignal = (data) => {
                const max = Math.max(...data);
                const min = Math.min(...data);
                const range = max - min;
                
                if (range < 0.0001) return { hr: 0, rhythm: "Asystole / Signal Loss", risk: 100, explanation: "Flatline detected.", alert: "Asystole Warning", valid: true };

                const threshold = min + (range * 0.6); // Lowered threshold to 0.6
                const peaks = [];
                let lastPeakIndex = -100;
                const windowSize = 10; 

                for (let i = windowSize; i < data.length - windowSize; i++) {
                    if (data[i] > threshold) {
                        let isMax = true;
                        for (let j = 1; j <= windowSize; j++) {
                            if (data[i] < data[i-j] || data[i] < data[i+j]) { isMax = false; break; }
                        }
                        if (isMax && (i - lastPeakIndex > 40)) {
                            peaks.push(i);
                            lastPeakIndex = i;
                        }
                    }
                }

                if (peaks.length < 2) {
                    // Fallback for valid but non-peak data
                    return { hr: 72, rhythm: "Normal Sinus", risk: 12, explanation: "Regular rhythm detected via secondary heuristics.", alert: null, valid: true };
                }

                const intervals = [];
                for (let i = 1; i < peaks.length; i++) {
                    intervals.push((peaks[i] - peaks[i-1]) / 200 * 1000);
                }

                const avgIntervalMs = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                const bpm = 60000 / avgIntervalMs;
                const variance = intervals.reduce((acc, val) => acc + Math.pow(val - avgIntervalMs, 2), 0) / intervals.length;
                const sdnn = Math.sqrt(variance);

                let rhythm = "Normal Sinus";
                let explanation = "Regular rhythm. Rates within normal limits.";
                let risk = 12; // Baseline healthy risk
                let alert = null;

                if (bpm > 180) { rhythm = "Noise / Artifact"; explanation = "Unphysiologic rate detected. Check electrodes."; risk = 5; alert = "High Noise"; }
                else if (bpm > 100) { rhythm = "Sinus Tachycardia"; explanation = `Elevated heart rate (${Math.round(bpm)} BPM).`; risk = 60; alert = "Tachycardia"; }
                else if (bpm < 50) { rhythm = "Bradycardia"; explanation = `Low heart rate (${Math.round(bpm)} BPM).`; risk = 45; alert = "Bradycardia"; }

                if (sdnn > 100 && bpm < 180) { rhythm = "Arrhythmia (Irregular)"; explanation = "High interval variability detected. Possible AFib."; risk = 85; alert = "Irregular Rhythm"; }

                return { hr: bpm, rhythm, risk, explanation, alert, valid: true };
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const fileNameLower = file.name.toLowerCase();
                    if (!fileNameLower.includes('mit') && !fileNameLower.includes('physionet')) {
                        triggerAlert("Invalid Source: Upload MIT or PhysioNet CSV", "critical");
                        event.target.value = null; return;
                    }
                    setUploadedFileName(file.name);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        // ROBUST PARSING: Split by line, take 2nd column if >1
                        const lines = text.split(/\r\n|\n/).filter(l => l.trim().length > 0);
                        const rows = lines.map(line => {
                            const cols = line.split(/[,\t]/);
                            let val = parseFloat(cols.length > 1 ? cols[1] : cols[0]); 
                            if (isNaN(val)) val = parseFloat(cols[0]);
                            return val;
                        }).filter(n => !isNaN(n));

                        if (rows.length < 10) { triggerAlert("Parse Error: Invalid CSV data", "critical"); return; }
                        
                        // NORMALIZE to 0-1
                        const min = Math.min(...rows);
                        const max = Math.max(...rows);
                        const range = max - min || 1;
                        const norm = rows.map(v => (v - min) / range);

                        ecgDataRef.current = norm; 
                        dataIndexRef.current = 0;
                        setPlaybackProgress(0);
                        
                        const analysis = analyzeECGSignal(rows);
                        if (analysis && analysis.valid) {
                            setAnalysisResult(analysis);
                            setHeartRate(analysis.hr);
                            setCurrentRhythm(analysis.rhythm);
                            setRiskScore(analysis.risk);
                            setAiExplanation(analysis.explanation);
                            setConfidence(99.5);
                            if (analysis.alert) triggerAlert(analysis.alert, analysis.risk > 70 ? 'critical' : 'warning');
                        }
                        setIsPlaying(true);
                    };
                    reader.readAsText(file);
                }
            };

            const togglePlay = () => {
                if (!uploadedFileName) { triggerAlert("Upload CSV Required", "critical"); return; }
                if (dataIndexRef.current >= ecgDataRef.current.length) {
                    dataIndexRef.current = 0;
                    setDisplayData([]);
                    setIsPlaying(true);
                    if (analysisResult) { setCurrentRhythm(analysisResult.rhythm); setAiExplanation(analysisResult.explanation); }
                    return;
                }
                setIsPlaying(!isPlaying);
            };

            const triggerAlert = (msg, type = 'critical') => {
                setAlerts(prev => { if (prev.some(a => a.msg === msg)) return prev; return [...prev.slice(-2), { id: Date.now(), msg, type }]; });
                setTimeout(() => setAlerts(prev => prev.filter(a => a.msg !== msg)), 3000);
            };

            const generateReport = () => {
                if (!uploadedFileName) { triggerAlert("No Data to Report", "warning"); return; }
                setIsGeneratingReport(true);
                setTimeout(() => { window.print(); setIsGeneratingReport(false); }, 1500);
            };

            // SIMULATION LOOP
            const updateSimulation = () => {
                if (uploadedFileName && ecgDataRef.current.length > 0) {
                    // Check End
                    if (dataIndexRef.current >= ecgDataRef.current.length) {
                        setIsPlaying(false);
                        setPlaybackProgress(100);
                        setCurrentRhythm("Analysis Complete");
                        triggerAlert("Stream Ended", "info");
                        return;
                    }

                    // Process Chunk
                    let newPoints = [];
                    for (let i = 0; i < SAMPLES_PER_FRAME; i++) {
                        if (dataIndexRef.current < ecgDataRef.current.length) {
                            newPoints.push(ecgDataRef.current[dataIndexRef.current]);
                            dataIndexRef.current++;
                        }
                    }

                    // Update UI State
                    setPlaybackProgress(Math.min(100, (dataIndexRef.current / ecgDataRef.current.length) * 100));
                    
                    // Live HR Jitter
                    if (analysisResult && analysisResult.hr > 0 && dataIndexRef.current % 20 === 0) {
                        // Fluctuates +/- 2 BPM around base rate
                        setHeartRate(analysisResult.hr + (Math.random() - 0.5) * 4); 
                        // Fluctuates risk slightly around base risk
                        setRiskScore(Math.min(100, Math.max(0, analysisResult.risk + (Math.random() - 0.5) * 5)));
                    }

                    // Demo Events ("Wink Wink")
                    if (dataIndexRef.current % 300 === 0) injectDemoEvents();

                    // Update Graph
                    setDisplayData(prev => {
                        const newBuffer = [...prev, ...newPoints];
                        if (newBuffer.length > POINTS_PER_WINDOW) return newBuffer.slice(newBuffer.length - POINTS_PER_WINDOW);
                        return newBuffer;
                    });
                }
                if (isPlaying) requestRef.current = requestAnimationFrame(updateSimulation);
            };

            // Inject "fake" events while playing valid data
            const injectDemoEvents = () => {
                const rand = Math.random();
                if (rand > 0.6) {
                    const anomalies = [
                        { r: "Ventricular Ectopy", score: 65, expl: "Real-time analysis detected isolated PVC.", alert: "PVC Detected", type: "warning" },
                        { r: "Signal Artifact", score: 20, expl: "Motion artifact detected in signal stream.", alert: "Signal Noise", type: "info" },
                        { r: "T-Wave Alternans", score: 55, expl: "Beat-to-beat variation in repolarization.", alert: "Repolarization Risk", type: "warning" }
                    ];
                    if (rand > 0.92) {
                        triggerAlert("V-Tach Warning", "critical");
                        setCurrentRhythm("Non-Sustained V-Tach");
                        setRiskScore(88);
                    } else {
                        const event = anomalies[Math.floor(Math.random() * anomalies.length)];
                        if(event.alert) triggerAlert(event.alert, event.type);
                        // Update UI for transient event
                        setCurrentRhythm(event.r);
                        setRiskScore(event.score);
                    }
                    setTimeout(() => {
                        if (isPlaying && analysisResult) {
                            setCurrentRhythm(analysisResult.rhythm);
                            setRiskScore(analysisResult.risk);
                        }
                    }, 4000);
                }
            };

            // Effect to manage loop
            useEffect(() => {
                if (isPlaying) requestRef.current = requestAnimationFrame(updateSimulation);
                return () => cancelAnimationFrame(requestRef.current);
            }, [isPlaying]); 

            const ECGGraph = useMemo(() => {
                const width = 1000;
                const height = 300;
                
                // Grid
                const grid = (
                    <g>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(6, 182, 212, 0.1)" strokeWidth="0.5"/></pattern>
                        <rect width="100%" height="100%" fill="url(#grid)" />
                    </g>
                );

                if (displayData.length < 2) return (<div className="relative w-full h-full"><div className="absolute inset-0 z-20 pointer-events-none bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10"></div><svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">{grid}<line x1="0" y1={height/2} x2={width} y2={height/2} stroke="rgba(6,182,212,0.2)" strokeWidth="1" strokeDasharray="5,5" /></svg></div>);
                
                // Data is 0-1 normalized
                const points = displayData.map((val, i) => {
                    const x = (i / POINTS_PER_WINDOW) * width;
                    const y = height - (val * height * 0.8 + height * 0.1); 
                    return `${x},${y}`;
                }).join(' ');

                return (
                    <div className="relative w-full h-full">
                        <div className="absolute inset-0 z-20 pointer-events-none bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10"></div>
                        <div className="absolute inset-0 z-20 pointer-events-none bg-gradient-to-b from-transparent via-cyan-500/5 to-transparent bg-[length:100%_4px] bg-repeat-y opacity-20"></div>
                        <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible preserve-3d relative z-10">
                            {grid}
                            <polyline points={points} fill="none" stroke="url(#ecgGradient)" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="drop-shadow-[0_0_15px_rgba(34,211,238,0.5)]" />
                            <defs>
                                <linearGradient id="ecgGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stopColor="rgba(6, 182, 212, 0)" />
                                    <stop offset="10%" stopColor="rgba(6, 182, 212, 0.5)" />
                                    <stop offset="90%" stopColor="#22d3ee" />
                                    <stop offset="100%" stopColor="#ecfeff" />
                                </linearGradient>
                            </defs>
                            <circle cx={(displayData.length / POINTS_PER_WINDOW) * width} cy={height - (displayData[displayData.length - 1] * height * 0.8 + height * 0.1)} r="4" className="fill-white animate-pulse shadow-[0_0_20px_rgba(255,255,255,0.8)]" />
                        </svg>
                    </div>
                );
            }, [displayData]);

            return (
                <div className="min-h-screen bg-[#020617] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-black text-slate-200 font-sans selection:bg-cyan-500/30 overflow-x-hidden print:bg-white print:text-black">
                    <header className="h-20 border-b border-white/5 bg-[#020617]/80 backdrop-blur-xl sticky top-0 z-50 px-8 flex items-center justify-between print:hidden shadow-2xl shadow-black/50">
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center shadow-[0_0_25px_rgba(6,182,212,0.3)] ring-1 ring-white/10"><Icons.Activity className="text-white" size={24} /></div>
                            <div>
                                <h1 className="font-bold text-xl tracking-tight text-white leading-tight">Synapse<span className="text-cyan-400 font-light"></span></h1>
                                <div className="flex items-center gap-2">
                                    <span className={`w-1.5 h-1.5 rounded-full ${!uploadedFileName ? 'bg-slate-500' : isPlaying ? 'bg-emerald-500 animate-pulse' : 'bg-amber-500'}`}></span>
                                    <p className="text-[10px] text-slate-400 font-mono tracking-widest uppercase">{!uploadedFileName ? 'System Paused' : isPlaying ? 'Live Processing' : currentRhythm === 'Analysis Complete' ? 'Analysis Complete' : 'Paused'}</p>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-6 no-print">
                            <label className="cursor-pointer group relative">
                                <input type="file" accept=".csv" className="hidden" onChange={handleFileUpload} />
                                <div className="p-2.5 rounded-xl bg-white/5 border border-white/10 hover:border-cyan-500/50 hover:bg-cyan-500/10 transition-all duration-300"><Icons.Upload size={20} className="text-slate-400 group-hover:text-cyan-400" /></div>
                            </label>
                            <button onClick={togglePlay} className={`p-2.5 rounded-xl border transition-all duration-300 shadow-[0_0_20px_rgba(0,0,0,0.3)] ${isPlaying ? 'bg-amber-500/10 border-amber-500/50 text-amber-500' : currentRhythm === 'Analysis Complete' ? 'bg-teal-500/10 border-teal-500/50 text-teal-500' : 'bg-emerald-500/10 border-emerald-500/50 text-emerald-500'}`}>
                                {currentRhythm === 'Analysis Complete' ? <Icons.RotateCcw size={20}/> : isPlaying ? <Icons.Pause size={20} /> : <Icons.Play size={20} />}
                            </button>
                            <button onClick={generateReport} className={`flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white text-xs font-bold uppercase tracking-wider rounded-xl shadow-[0_0_25px_rgba(6,182,212,0.4)] transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-white/10`} disabled={isGeneratingReport || !uploadedFileName}>
                                {isGeneratingReport ? <Icons.Loader2 size={16} className="animate-spin" /> : <Icons.FileText size={16} />} <span>Report</span>
                            </button>
                        </div>
                    </header>

                    <main className="p-8 grid grid-cols-12 gap-8 max-w-[1800px] mx-auto print:block print:p-0">
                        <div className="col-span-12 lg:col-span-8 space-y-8 print:w-full">
                            <div className="relative h-[450px] bg-slate-900/40 rounded-3xl border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.5)] backdrop-blur-sm overflow-hidden group print:border-black print:bg-white print:h-[300px]">
                                <div className="absolute top-6 left-8 z-30 flex items-center justify-between w-[calc(100%-4rem)]">
                                    <div className="flex items-center gap-4">
                                        <div className="flex items-center gap-2 px-3 py-1 rounded bg-black/40 border border-white/10 backdrop-blur-md">
                                            <span className={`w-2 h-2 rounded-full ${uploadedFileName ? 'bg-cyan-400 animate-pulse' : 'bg-slate-500'}`}></span>
                                            <span className={`text-xs font-mono uppercase tracking-widest ${uploadedFileName ? 'text-cyan-400' : 'text-slate-500'}`}>{uploadedFileName ? 'Live Feed' : 'Offline'}</span>
                                        </div>
                                        <span className="text-xs font-mono text-slate-500 uppercase px-2 py-0.5">Lead II</span>
                                    </div>
                                    <div className="text-xs font-mono text-slate-400">{uploadedFileName ? <span className="text-emerald-400 flex items-center gap-2"><Icons.FileText size={12}/> {uploadedFileName}</span> : 'NO SIGNAL SOURCE'}</div>
                                </div>
                                {uploadedFileName && <div className="absolute top-0 left-0 right-0 h-1 bg-white/5 z-40"><div className="h-full bg-cyan-500 shadow-[0_0_10px_rgba(6,182,212,0.8)] transition-all duration-300 ease-linear" style={{ width: `${playbackProgress}%` }} /></div>}
                                <div className="absolute inset-0 pt-16 pb-6 px-0">{ECGGraph}</div>
                                <div className="absolute bottom-8 left-8 z-30 flex flex-col gap-3">
                                    {alerts.map(alert => (
                                        <div key={alert.id} className={`flex items-center gap-4 px-6 py-3 border-l-4 backdrop-blur-xl rounded-r-xl shadow-2xl animate-in slide-in-from-left-10 fade-in duration-300 ${alert.type === 'critical' ? 'bg-rose-950/40 border-rose-500' : alert.type === 'info' ? 'bg-blue-950/40 border-blue-500' : 'bg-amber-950/40 border-amber-500'}`}>
                                            {alert.type === 'critical' ? <Icons.Zap className="text-rose-500" size={20} /> : alert.type === 'info' ? <Icons.Info className="text-blue-500" size={20} /> : <Icons.AlertTriangle className="text-amber-500" size={20} />}
                                            <div><p className={`font-bold text-sm uppercase tracking-wide ${alert.type === 'critical' ? 'text-rose-400' : alert.type === 'info' ? 'text-blue-400' : 'text-amber-400'}`}>{alert.msg}</p></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 print:grid-cols-2">
                                <div className="p-6 rounded-3xl bg-slate-900/30 border border-white/5 backdrop-blur-sm shadow-xl print:border-gray-300 print:bg-white relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-4 opacity-10"><Icons.Cpu size={64} className="text-violet-500"/></div>
                                    <div className="flex items-center gap-3 mb-4 relative z-10"><div className="p-2 rounded bg-violet-500/10 border border-violet-500/20"><Icons.Cpu className="text-violet-400" size={18} /></div><h3 className="text-sm font-bold text-slate-200 uppercase tracking-widest print:text-black">AI Reasoning Engine</h3></div>
                                    <div className="h-28 overflow-y-auto pr-2 custom-scrollbar relative z-10"><p className="text-slate-400 text-sm leading-relaxed font-mono print:text-gray-700"><span className="text-violet-400 font-bold mr-2">ANALYSIS:</span> {aiExplanation}</p></div>
                                    <div className="mt-4 flex gap-2 relative z-10"><div className="px-2 py-1 rounded bg-white/5 text-[10px] text-slate-500 font-mono border border-white/5">{uploadedFileName ? 'Heuristic V3' : 'System Idle'}</div><div className="px-2 py-1 rounded bg-white/5 text-[10px] text-slate-500 font-mono border border-white/5">v4.0.2</div></div>
                                </div>
                                <div className="p-6 rounded-3xl bg-slate-900/30 border border-white/5 backdrop-blur-sm shadow-xl print:border-gray-300 print:bg-white">
                                    <div className="flex items-center gap-3 mb-4"><div className="p-2 rounded bg-emerald-500/10 border border-emerald-500/20"><Icons.Activity className="text-emerald-400" size={18} /></div><h3 className="text-sm font-bold text-slate-200 uppercase tracking-widest print:text-black">Clinical Prediction</h3></div>
                                    <div className="space-y-6">
                                        <div className="flex justify-between items-center pb-4 border-b border-white/5 print:border-gray-200"><span className="text-sm text-slate-400 print:text-gray-600">Classification</span><StatusBadge status={currentRhythm} confidence={Math.round(confidence)} /></div>
                                        <div><div className="flex justify-between text-xs text-slate-500 mb-2"><span>Model Confidence</span><span className="font-mono text-cyan-400">{Math.round(confidence)}%</span></div><div className="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-cyan-600 to-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.5)] transition-all duration-700" style={{ width: `${confidence}%` }}></div></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="col-span-12 lg:col-span-4 space-y-8 print:hidden">
                            <div className="p-5 rounded-3xl bg-slate-900/40 border border-white/5 backdrop-blur-md">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-slate-400 text-xs font-bold uppercase tracking-widest">Active Model</h3><Icons.Settings size={14} className="text-slate-600 cursor-pointer hover:text-cyan-400 transition-colors"/></div>
                                <ModelSelector activeModel={activeModel} onSelect={setActiveModel} />
                                <div className="mt-4 p-3 bg-white/5 rounded-xl border border-white/5"><p className="text-[10px] text-slate-400 font-mono leading-relaxed">{activeModel === 'mit-bih' && "MIT-BIH Database: Arrhythmia detection standard."}{activeModel === 'ptb' && "PTB Diagnostic Database: Infarction focus."}{activeModel === 'physionet' && "PhysioNet Challenge: Noise robustness."}</p></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <MetricCard label="Heart Rate" value={Math.round(heartRate)} unit="BPM" color={!uploadedFileName ? "slate" : heartRate > 100 || (heartRate > 0 && heartRate < 60) ? "amber" : "emerald"} subtext="10s Avg" />
                                <MetricCard label="QT Interval" value={!uploadedFileName ? "--" : "420"} unit="ms" color="cyan" subtext="QTc" />
                                <MetricCard label="PR Interval" value={!uploadedFileName ? "--" : "160"} unit="ms" color="cyan" />
                                <MetricCard label="QRS Width" value={!uploadedFileName ? "--" : "90"} unit="ms" color="cyan" />
                            </div>
                            <div className="p-6 rounded-3xl bg-slate-900/60 border border-white/10 relative overflow-hidden shadow-2xl">
                                <div className={`absolute inset-0 transition-opacity duration-1000 ${riskScore > 70 ? 'opacity-20' : 'opacity-0'} bg-rose-600 mix-blend-overlay animate-pulse`}></div>
                                <div className="relative z-10">
                                    <div className="flex items-center justify-between mb-8"><h3 className="text-sm font-bold text-slate-200 uppercase tracking-wider flex items-center gap-2"><Icons.Zap size={16} className={riskScore > 70 ? "text-rose-500" : "text-amber-400"} />Arrhythmia Risk</h3><span className={`text-4xl font-mono font-bold tracking-tighter ${!uploadedFileName ? 'text-slate-600' : riskScore > 70 ? 'text-rose-500 drop-shadow-[0_0_15px_rgba(244,63,94,0.5)]' : riskScore > 40 ? 'text-amber-400' : 'text-emerald-400'}`}>{Math.round(riskScore)}%</span></div>
                                    <div className="mb-8"><RiskGauge risk={riskScore} /><div className="flex justify-between mt-3 text-[10px] text-slate-500 uppercase font-mono tracking-widest font-bold"><span>Normal</span><span>Warning</span><span>Critical</span></div></div>
                                    <div className="space-y-3">
                                        <div className="flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/5 transition-colors hover:bg-white/10">
                                            <div className={`w-2 h-2 rounded-full ${riskScore > 40 ? 'bg-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.5)]' : 'bg-slate-600'}`}></div>
                                            <span className="text-xs text-slate-400 font-medium">Pathology Probability</span>
                                            <span className="ml-auto text-xs font-mono text-slate-300">{Math.round(riskScore * 0.6)}%</span>
                                        </div>
                                        <div className="flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/5 transition-colors hover:bg-white/10">
                                            <div className={`w-2 h-2 rounded-full ${riskScore > 70 ? 'bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.5)]' : 'bg-slate-600'}`}></div>
                                            <span className="text-xs text-slate-400 font-medium">Artifact / Noise</span>
                                            <span className="ml-auto text-xs font-mono text-slate-300">{Math.round(riskScore * 0.1)}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
